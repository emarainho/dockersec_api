openapi: 3.0.0

info:
  version: '1.0.0'
  title: 'DockerSec Tool - API'
  description: 'API to enable Container Security in CI/CD Pipelines'
  license:
    name: GPLv3
    url: https://www.gnu.org/licenses/gpl-3.0.en.html
  
servers:
  # Added by API Auto Mocking Plugin
  - description: SwaggerHub API Auto Mocking
    url: https://virtserver.swaggerhub.com/ema.rainho/dockersec_api/1.0.0
  - description: Sandbox server (uses test data) 
    url: https://localhost:8080/v1

paths:
  /health:
    get:
      summary: Returns the API health status
      responses:
         '200':
          description: API Health Status response (up/down)
          content:
            application/json:
              schema:
                type: object
                properties:
                  api_status:
                    type: string
                    enum:
                    - "up"
                    - "down"

  /version:
    get:
      summary: Returns the API version
      responses:
         '200':
          description: API version number response
          content:
            application/json:
              schema:
                type: object
                properties:
                  api_version:
                    type: string
                    enum:
                    - "1.0.0"

  /analysis/create:
    post:
      summary: Create a new Analysis according to the uploaded definition
      requestBody:
        content:
          application/octet-stream:
            schema:
              # docker-sec.yaml definition to upload.
              type: string
              format: binary
      responses:
        '400':
          description: The specified YAML definition is invalid (e.g. not a valid YAML)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: The YAML definition for a new analysis was not found
        '200':
          description: Returns new analysis name, analysisId and accepted code
          content:
            application/json:
              schema:
                type: object
                properties:
                  analysis_id:
                    type: integer
                    format: int64
                  analysis_name:
                    type: string
                  accepted:
                    type: boolean

  /analysis/{analysisId}/abort:
    delete:
      summary: Abort a Analysis by ID
      parameters:
        - name: analysisId
          in: path
          required: true
          description: The ID of the Analysis to abort
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Returns ID of analysis to abort and abort_status
          content:
            application/json:
              schema:
                type: object
                properties:
                  analysis_id:
                    type: integer
                    format: int64
                  abort_status:
                    type: string
                    enum:
                    - pass
                    - fail

  /analysis/{analysisId}/progress:
    get:
      summary: Progress of an Analysis by ID
      parameters:
        - name: analysisId
          in: path
          required: true
          description: The Progress of Analysis Steps/Stages 1,2,3 and tool tasks (return status and tasks/stages IDs)
          schema:
            type: integer
            format: int64
      responses:
        '400':
          description: The specified analysisId is invalid (e.g. not a number)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: The analysis with the specified ID was not found
        '200':
          description: Analysis progress response
          content:
            application/json:
              schema:
                type: object
                properties:
                  analysis_id:
                    type: integer
                  analysis_name:
                    type: string
                  progress:
                    type: string
                    enum: 
                    - accepted
                    - ongoing
                    - completed
                  # number of steps/stages are configurable in docker-sec.yaml
                  step1_id:
                    type: integer
                  step1_status:
                    type: string
                  step2_id:
                    type: integer
                  step2_status:
                    type: string
                  step3_id:
                    type: integer
                  step3_status:
                    type: string
                  # last step in analysis
                  laststep_id:
                    type: integer
                  laststep_name:
                    type: integer

  /analysis/{analysisId}/step/{stepId}/tasks:
    get:
      summary: Returns tasks for a stepId
      parameters:
        - name: analysisId
          in: path
          required: true
          description: The ID of the Step to retrieve Tasks
          schema:
            type: integer
            format: int64
        - name: stepId
          in: path
          required: true
          description: The ID of the Task to return
          schema:
            type: integer
            format: int32
      responses:
        '400':
          description: The specified analysisId or stepId is invalid (e.g. not a number)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: The analysis or step with the specified IDs was not found
        '200':
          description: Returns tasks from a Step in analysisId
          content:
            application/json:
              schema:
                type: object
                properties:
                  step_id:
                    type: integer
                  step_name:
                    type: string
                  task_list:
                    type: array
                    items:
                      $ref: '#/components/schemas/Task'

  /analysis/{analysisId}/results:
    get:
      summary: Returns results status of Analysis (can include report if complete)
      parameters:
        - name: analysisId
          in: path
          required: true
          description: The ID of the Analysis
          schema:
            type: integer
            format: int64
      responses:
        '400':
          description: The specified analysisId is invalid (e.g. not a number)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: The Analysis with the specified ID was not found
        '200':
          description: Analysis Status response (can include Report results if finished)
          content:
            application/json:
              schema:
                type: object
                properties:
                  analysis_id:
                    type: integer
                    format: int64
                  analysis_status:
                    type: string
                  report_id:
                    type: integer
                  report_results:
                    type: object

  /tools/create:
    post:
      summary: Create a new Tool according to the uploaded definition
      requestBody:
        content:
          application/octet-stream:
            schema:
              # Dockerfile to upload.
              type: string
              format: binary
      responses:
        '400':
          description: The specified Dockerfile definition is invalid (e.g. not a valid Dockerfile)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: The Dockerfile definition for a new Tool was not found
        '200':
          description: Returns new Tool name, toolId and accepted code
          content:
            application/json:
              schema:
                type: object
                properties:
                  tool_id:
                    type: integer
                    format: int64
                  tool_name:
                    type: string
                  accepted:
                    type: boolean
      security:
      - ApiKeyAuth: []

  /tools/list:
    get:
      summary: Collect available Security Tools
      responses:
        '200':
          description: Returns a list of Security Tools
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tool'
                example: ["str1", "str2", "str3"]

  /tools/{toolId}/details:
    get:
      summary: Returns details of specific Security Tool
      parameters:
        - name: toolId
          in: path
          required: true
          description: The ID of the tool
          schema:
            type: integer
            format: int64
      responses:
         '200':
          description: The Dockerfile of the Security Tool with identified by toolId
          content:
            application/json:
              schema:
                type: object
                properties:
                  tool_id:
                    type: integer
                    format: int64
                  tool_name:
                    type: string
                  tool_status:
                    type: string
                  dockerfile_id:
                    type: integer
                    format: int64
                  dockerfile_dump:
                    type: object

components:
  responses:
    UnauthorizedError:
      description: API key is missing or invalid
      headers:
        WWW_Authenticate:
          schema:
            type: string
  schemas:
    Tool:
      type: object
      properties:
        tool_id:
          type: integer
          format: int64
        tool_name:
          type: string
        tool_type:
          type: string
        tool_definition:
          type: string
    Task:
      type: object
      properties:
        task_id:
          type: integer
          format: int64
        task_name:
          type: string
        task_type:
          type: string
        task_definition:
          type: string
  securitySchemes:
    # Define the key name and location
    ApiKeyAuth:        # arbitrary name for the security scheme
      type: apiKey
      in: header       # can be "header", "query" or "cookie"
      name: X-API-KEY  # name of the header, query parameter or cookie

# 2) Apply the security globally to all operations
security:
  - ApiKeyAuth: []         # use the same name as above